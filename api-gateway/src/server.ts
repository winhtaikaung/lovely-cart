import axios from 'axios';
import bodyParser from 'body-parser';
import cors from 'cors';
import express from 'express';
import { createServer, Server } from 'http';
import nanoid from 'nanoid';
import socketIo from 'socket.io';
import { CartEvents, QMethods } from './types/event';

import { ICartGroup, ICartItem, IResponse, IUser } from './types/message';
import { Method } from './types/method';

import cacheManager, { Cache } from 'cache-manager';
import { MQHelper } from './helper/mq-async-helper';

const mockData={"bundle_templates":[{"id":15,"name":"The Himalayas Cold‑pressed Juice","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/15/HIMALAYAS.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/15/HIMALAYAS.jpg","description":"The Himalayas will get you back into gear with watermelon, beetroot, lime and Himalayan pink sea salt. The ideal pre-workout elixir, beetroot juice has been proven to aid peak performance among top athletes. Perfectly balanced with refreshing lime and hydrating watermelon, this is the perfect pick-me-up. 100% cold-pressed to keep you at your best.","byline":"watermelon, beetroot, lime, himalayan pink sea salt","pax_recommendation":null,"base_price":6.95,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/15/HIMALAYAS.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/15/HIMALAYAS.jpg","bundle_template_slots":[{"id":63,"bundle_template_id":15,"category":"drink","type":"FixedBundleTemplateSlot","meals":[{"id":510,"meal_id":"HIMALAYAS","name":"The Himalayas Cold‑pressed Juice","temperature":"chilled","category":"drink","byline":"watermelon, beetroot, lime, himalayan pink sea salt","price":6.95,"tag_list":"vegan, antioxidant-rich"}]}]},{"id":16,"name":"Little Gingy Cold‑pressed Juice","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/16/GINGY.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/16/GINGY.jpg","description":"Little Gingy packs an immunity-boosting kick with the goodness of orange, carrot, ginger and turmeric. Loaded with the anti-inflammatory effects of turmeric and ginger, this is a refreshing and fruity juice that will brighten your day. 100% cold-pressed to keep you at your best. ","byline":"orange, carrot, ginger and turmeric","pax_recommendation":null,"base_price":6.95,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/16/GINGY.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/16/GINGY.jpg","bundle_template_slots":[{"id":64,"bundle_template_id":16,"category":"drink","type":"FixedBundleTemplateSlot","meals":[{"id":511,"meal_id":"LILGINGY","name":"Little Gingy Cold‑pressed Juice","temperature":"chilled","category":"drink","byline":"orange, carrot, ginger and turmeric","price":6.95,"tag_list":"vegan, antioxidant-rich"}]}]},{"id":17,"name":"Golden Manuka Cold‑pressed Juice","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/17/MANUKA.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/17/MANUKA.jpg","description":"A little sweet and a little tangy. This refreshing juice combines the natural sweetness from Manuka honey, pineapple and apple with mild acidity from lemon. Manuka honey, produced in New Zealand is a true superfood with energy-boosting properties. Go ahead and treat yourself to this pure liquid gold.","byline":"manuka honey, pineapple, apple and lemon ","pax_recommendation":null,"base_price":6.95,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/17/MANUKA.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/17/MANUKA.jpg","bundle_template_slots":[{"id":65,"bundle_template_id":17,"category":"drink","type":"FixedBundleTemplateSlot","meals":[{"id":531,"meal_id":"MANUKA","name":"Golden Manuka Cold‑pressed Juice","temperature":"chilled","category":"drink","byline":"manuka honey, pineapple, apple and lemon ","price":6.95,"tag_list":"antioxidant-rich"}]}]},{"id":18,"name":"Pink Coconut Water","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/18/COCO-new.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/18/COCO-new.jpg","description":"This coconut water blushes with time due to the natural reaction of a naturally-occurring antioxidant called polyphenol with light. Deeper pinks simply mean higher levels of polyphenols. Only true raw unadulterated coconut water turns pink. No wonder it tastes so good.","byline":"by cocoloco","pax_recommendation":null,"base_price":5.5,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/18/COCO-new.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/18/COCO-new.jpg","bundle_template_slots":[{"id":66,"bundle_template_id":18,"category":"drink","type":"FixedBundleTemplateSlot","meals":[{"id":186,"meal_id":"COCO","name":"Pink Coconut Water","temperature":"chilled","category":"drink","byline":"by cocoloco","price":5.5,"tag_list":"fresh coconut, refreshing"}]}]},{"id":19,"name":"Benns Sungai Ruan 72% Dark Chocolate with Cacao Nibs","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/19/BENNS_SUNGEIRUAN.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/19/benns_sungeiruan_1_.jpg","description":"Sourced from the Koh family farm in Sungai Ruan surrounded by fruit plantations, this chocolate is unlike your usual flat-tasting dark chocolate. It has a unique fruity taste of blackcurrant and raisins. Cacao nibs give it a crunchy texture and a slight roasted flavour with every bite. This is chocolate in its purest form.","byline":"dark chocolate with tasting notes of blackcurrants, raisins and almonds","pax_recommendation":null,"base_price":5.95,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/19/BENNS_SUNGEIRUAN.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/19/benns_sungeiruan_1_.jpg","bundle_template_slots":[{"id":67,"bundle_template_id":19,"category":"dessert","type":"FixedBundleTemplateSlot","meals":[{"id":660,"meal_id":"SUNGAIRUANWNIB","name":"Benns Sungai Ruan 72% Dark Chocolate with Cacao Nibs","temperature":"chilled","category":"dessert","byline":"dark chocolate with tasting notes of blackcurrants, raisins and almonds","price":5.95,"tag_list":"antioxidant-rich, vegan"}]}]},{"id":20,"name":"Benns Anaimalai 72% Dark Chocolate","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/20/BENNS_ANAIMALAI.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/20/benns_anaimalai__1_.jpg","description":"If Anaimalai 72% Dark is a human being, we would describe him or her as bright and cheery. It is chocolatey, with a pop of nutty flavour and natural sweetness of golden, sun maid raisins. One piece of this chocolate can lift your mood instantly. ","byline":"dark chocolate with tasting notes of sun maid raisins and cashew nuts","pax_recommendation":null,"base_price":5.95,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/20/BENNS_ANAIMALAI.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/20/benns_anaimalai__1_.jpg","bundle_template_slots":[{"id":68,"bundle_template_id":20,"category":"dessert","type":"FixedBundleTemplateSlot","meals":[{"id":661,"meal_id":"ANAIMALAI","name":"Benns Anaimalai 72% Dark Chocolate","temperature":"chilled","category":"dessert","byline":"dark chocolate with tasting notes of sun maid raisins and cashew nuts","price":5.95,"tag_list":"antioxidant-rich, vegan"}]}]},{"id":21,"name":"Mixed Fruit Parcel","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/21/single_fruitplatter.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/21/Fruits_1_Vertical.JPG","description":"Now you have no excuses to skip your daily intake of fruits. We’ve picked the sweetest and juiciest of them all, and cut them into bite-sized pieces for you. Add it to your order for an extra boost after a meal.","byline":"a medley of grapes, honeydew, kiwi and strawberries sealed in a parcel","pax_recommendation":null,"base_price":4.95,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/21/single_fruitplatter.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/21/Fruits_1_Vertical.JPG","bundle_template_slots":[{"id":69,"bundle_template_id":21,"category":"dessert","type":"FixedBundleTemplateSlot","meals":[{"id":668,"meal_id":"SINGLEFRUITPLATTER","name":"Mixed Fruit Parcel","temperature":"chilled","category":"dessert","byline":"a medley of grapes, honeydew, kiwi and strawberries sealed in a parcel","price":4.95,"tag_list":"high fibre, refreshing"}]}]},{"id":22,"name":"Cinnamon Churro Waffles","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/22/single_wafflesmex.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/22/Waffles_Vertical.JPG","description":"If you are serious about churros, and serious about Belgian waffles, the Cinnamon Churro Waffles was made with you in mind. Golden brown waffles is coated with cinnamon sugar and a combination of Mexican spices like cayenne pepper and cumin, then topped with rosemary. No one would have imagined that the cross-breed of churros and waffles can taste this great. No one, other than the man behind this dessert.","byline":"with rosemary, cumin and cayenne pepper","pax_recommendation":null,"base_price":4.95,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/22/single_wafflesmex.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/22/Waffles_Vertical.JPG","bundle_template_slots":[{"id":70,"bundle_template_id":22,"category":"dessert","type":"FixedBundleTemplateSlot","meals":[{"id":663,"meal_id":"SINGLEWAFFLESMEX","name":"Cinnamon Churro Waffles","temperature":"chilled","category":"dessert","byline":"with rosemary, cumin and cayenne pepper","price":4.95,"tag_list":"contains dairy, contains egg, mexican"}]}]},{"id":23,"name":"Salted Egg Yolk Muah Chee","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/23/single_saltedeggmuahchee.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/23/Muah_Chee_Vertical.JPG","description":"It’s hardly a secret that we have a thing for salted egg yolk — we would add them to any food if people don’t judge. So, we were pretty excited when our chefs came up with a rice cake that has salted egg yolk both inside and outside of it. Before you sink your teeth into this dessert, the rich flavour from the salted egg yolk and peanut mixture coats your tongue. And when you take your first bite, the salted egg yolk filling hits you and leaves you in a state of bliss.","byline":"rice cake with salted egg yolk filling and grated peanut","pax_recommendation":null,"base_price":5.95,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/23/single_saltedeggmuahchee.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/23/Muah_Chee_Vertical.JPG","bundle_template_slots":[{"id":71,"bundle_template_id":23,"category":"dessert","type":"FixedBundleTemplateSlot","meals":[{"id":664,"meal_id":"SINGLEEGGMUAHCHEE","name":"Salted Egg Yolk Muah Chee","temperature":"warm","category":"dessert","byline":"rice cake with salted egg yolk filling and grated peanut","price":5.95,"tag_list":"contains egg, contains nut, sweet treat"}]}]},{"id":24,"name":"Seafood Beancurd Skin Roll","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/24/single_seafoodroll.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/24/Beancurd_Vertical.JPG","description":"This is not your typical beancurd skin roll from the dim sum restaurant. This is one that will make you go — holy cow, what kind of beancurd skin rolls have I been eating? We have elevated it with a unique sesame oyster sauce that is incredibly fragrant. One mouthful of this and you will be rolling hard.","byline":"with spinach and sesame oyster sauce","pax_recommendation":null,"base_price":6.95,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/24/single_seafoodroll.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/24/Beancurd_Vertical.JPG","bundle_template_slots":[{"id":72,"bundle_template_id":24,"category":"side","type":"FixedBundleTemplateSlot","meals":[{"id":666,"meal_id":"SINGLESEAFOODROLL","name":"Seafood Beancurd Skin Roll","temperature":"warm","category":"side","byline":"with spinach and sesame oyster sauce","price":6.95,"tag_list":"contains dairy, high protein, cantonese"}]}]},{"id":25,"name":"Century Egg Liang Ban Tofu","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/25/single_liangbantofu.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/25/Toufu_Vertical.JPG","description":"There’s tofu, there’s Mapo tofu, there’s ordinary liang ban tofu, and then there’s liang ban tofu with our extraordinary preserved radish mix. It is crunchy, fragrant and an absolute flavour bomb — a perfect match with the refreshing chilled tofu.","byline":"chinese cold tofu with century egg, preserved radish and shallot","pax_recommendation":null,"base_price":4.5,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/25/single_liangbantofu.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/25/Toufu_Vertical.JPG","bundle_template_slots":[{"id":73,"bundle_template_id":25,"category":"side","type":"FixedBundleTemplateSlot","meals":[{"id":665,"meal_id":"SINGLELIANGBANTOFU","name":"Century Egg Liang Ban Tofu","temperature":"chilled","category":"side","byline":"chinese cold tofu with century egg, preserved radish and shallot","price":4.5,"tag_list":"contains egg, contains sesame, chinese"}]}]},{"id":26,"name":"Mexican Street Corn","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/26/single_mexicancorn.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/26/Corn_Vertical.JPG","description":"Chances are when you think of Mexico, you think of corn, or food made with corn (like a tortilla). A favourite street food in Mexico, corn is commonly grilled, and served on the cob with a mix of sour cream, parmesan, etc. We took this favourite, removed the kernels from the cob, sautéed them with butter, then topped it up with a little bit of Chef Isaac’s magic - a paprika-spiced charred onion mayonnaise. Tastier and hassle-free, what’s not to love?","byline":"with charred onion mayonnaise","pax_recommendation":null,"base_price":4.5,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/26/single_mexicancorn.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/26/Corn_Vertical.JPG","bundle_template_slots":[{"id":74,"bundle_template_id":26,"category":"side","type":"FixedBundleTemplateSlot","meals":[{"id":667,"meal_id":"SINGLEMEXICANCORN","name":"Mexican Street Corn","temperature":"warm","category":"side","byline":"with charred onion mayonnaise","price":4.5,"tag_list":"contains dairy, high fibre, mexican"}]}]},{"id":27,"name":"Charred Red Cabbage Quinoa Salad","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/27/CABBAGEQUINOA_h.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/27/CABBAGEQUINOA_v.jpg","description":"Red cabbage takes centre stage here, with an extra depth of flavour from the char. This is accompanied by root vegetables, roasted with a dash of salt and pepper for a clean taste and slight smokiness. We brighten the dish with a touch of acidity from our balsamic vinaigrette. If you are eating this with your friends, guard it closely. It can get polished off as soon as it hits the table.","byline":"with roasted root vegetables and balsamic vinaigrette","pax_recommendation":null,"base_price":10,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/27/CABBAGEQUINOA_h.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/27/CABBAGEQUINOA_v.jpg","bundle_template_slots":[{"id":75,"bundle_template_id":27,"category":"regular","type":"FixedBundleTemplateSlot","meals":[{"id":658,"meal_id":"CABBAGEQUINOA","name":"Charred Red Cabbage Quinoa Salad","temperature":"warm","category":"regular","byline":"with roasted root vegetables and balsamic vinaigrette","price":10,"tag_list":"contains dairy, antioxidant-rich, vegetarian"}]}]},{"id":28,"name":"Pan‑seared Meltique Steak","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/28/STEAKANDKALE_h.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/28/STEAKANDKALE_v.jpg","description":"You don’t have to be in a steakhouse to enjoy good steak. You don’t even have to leave your chair — get our Pan-seared Meltique Beef Steak delivered to you. Our meltique beef sirloin is seared for a caramelised brown crust, and served with parmesan chimichurri for a bit of tang. If you ever wondered how heaven tastes like, this is it.","byline":"with parmesan chimichurri, sautéed kale and portobello","pax_recommendation":null,"base_price":21.95,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/28/STEAKANDKALE_h.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/28/STEAKANDKALE_v.jpg","bundle_template_slots":[{"id":76,"bundle_template_id":28,"category":"regular","type":"FixedBundleTemplateSlot","meals":[{"id":659,"meal_id":"STEAKANDKALE","name":"Pan‑seared Meltique Steak","temperature":"warm","category":"regular","byline":"with parmesan chimichurri, sautéed kale and portobello","price":21.95,"tag_list":"contains dairy, high protein"}]}]},{"id":29,"name":"Torched Norwegian Salmon","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/29/SALMONTORCH_h.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/29/SALMONTORCH_v.jpg","description":"This vibrant dish is a real feast for the senses. Norwegian salmon is sous-vided for a smooth and buttery texture. A zesty citrus vinaigrette keeps things fresh along with crunchy edamame beans, cherry tomatoes and fusilli pasta. Super-satisfying and nutritious, it’s as good for you as it looks.","byline":"with citrus vinaigrette on parsley-spinach fusilli","pax_recommendation":null,"base_price":16.95,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/29/SALMONTORCH_h.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/29/SALMONTORCH_v.jpg","bundle_template_slots":[{"id":77,"bundle_template_id":29,"category":"regular","type":"FixedBundleTemplateSlot","meals":[{"id":657,"meal_id":"SALMONTORCH","name":"Torched Norwegian Salmon","temperature":"chilled","category":"regular","byline":"with citrus vinaigrette on parsley-spinach fusilli","price":16.95,"tag_list":"high protein"}]}]},{"id":30,"name":"Grilled Farm Fresh Chicken","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/30/CGFARMFRESH_h.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/30/CGFARMFRESH_v.jpg","description":"Made using succulent chicken thigh, our Grilled Farm Fresh Chicken is garlicky, zesty and pairs perfectly with our multi-grain rice. We seasoned our cherry tomatoes with oregano-infused olive oil to make them sweet and aromatic. Complete with the bold flavours of basil, parsley and peanut in our signature pesto, this dish will have you hooked from the first bite.","byline":"with herbed cherry tomato and pesto on spiced multi-grain rice","pax_recommendation":null,"base_price":10,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/30/CGFARMFRESH_h.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/30/CGFARMFRESH_v.jpg","bundle_template_slots":[{"id":78,"bundle_template_id":30,"category":"regular","type":"FixedBundleTemplateSlot","meals":[{"id":656,"meal_id":"CGFARMFRESH","name":"Grilled Farm Fresh Chicken","temperature":"warm","category":"regular","byline":"with herbed cherry tomato and pesto on spiced multi-grain rice","price":10,"tag_list":"contains peanut, high protein"}]}]},{"id":31,"name":"Basil Thunder Tea Rice","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/31/3D54BC29-F5CF-4EB7-AD07-06DD2AED69C6.jpeg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/31/C561B801-A544-488F-9130-6FC540A9C81A.jpeg","description":"If you are looking for your ordinary thunder tea rice, skip this. But if you want something herbal and flavourful while still retaining the essence of this Hakka dish, this is right up your alley. Just like typical thunder tea rice, this dish has a mix of vegetables and beans. But the key, lies in the ginseng tie guan yin broth. It is packed with nutritious ingredients like ginseng, goji berries and dang gui. An ultimate feel-good dish that makes you happy every time.","byline":"with ginseng tie guan yin broth","pax_recommendation":null,"base_price":10,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/31/3D54BC29-F5CF-4EB7-AD07-06DD2AED69C6.jpeg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/31/C561B801-A544-488F-9130-6FC540A9C81A.jpeg","bundle_template_slots":[{"id":79,"bundle_template_id":31,"category":"highlight","type":"FixedBundleTemplateSlot","meals":[{"id":672,"meal_id":"BASILTIEGUANYIN","name":"Basil Thunder Tea Rice","temperature":"warm","category":"highlight","byline":"with ginseng tie guan yin broth","price":10,"tag_list":"contains nut, high fibre, vegetarian"}]}]},{"id":32,"name":"Nasi Lemak Ayam Masak Merah","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/32/Nasi_Lemak.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/32/Nasi_Lemak.jpg","description":"Never mind if Nasi Lemak originated from Singapore or Malaysia. Our healthier version is born in the Grain kitchen and it is absolutely sedap. We seasoned our chicken thigh with a spicy tomato sauce, then baked it to form our own version of the traditional Malaysian dish, Ayam Masak Merah. Aromatic basmati rice is mixed with black and brown rice for extra nutrients and fibre. Topped with housemade sambal and soft-boiled egg, this dish definitely hits the spot.","byline":"with housemade sambal, sunflower seeds and soft-boiled egg","pax_recommendation":null,"base_price":10,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/32/Nasi_Lemak.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/32/Nasi_Lemak.jpg","bundle_template_slots":[{"id":80,"bundle_template_id":32,"category":"highlight","type":"FixedBundleTemplateSlot","meals":[{"id":573,"meal_id":"LEMAKMERAH","name":"Nasi Lemak Ayam Masak Merah","temperature":"warm","category":"highlight","byline":"with housemade sambal, sunflower seeds and soft-boiled egg","price":10,"tag_list":"spicy, high protein, local"}]}]},{"id":33,"name":"Unagi Kabayaki","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/33/008BF66F-1F20-499E-B208-04B4646235C9.jpeg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/33/Unagi.jpg","description":"This dish is no stranger to Japanese food lovers. That familiar sweet-savoury taste that accompanies a soft, fatty flesh makes it oh-so comforting, especially on a stressful day at work. We serve it with Japanese rice pearls and a refreshing dill tsukemono — Japanese pickles perfumed with fresh herb. The result is a perfect balance of sweet, savoury and tart. Eel like it for sure.","byline":"with dill tsukemono on sweet soy japanese rice","pax_recommendation":null,"base_price":17,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/33/008BF66F-1F20-499E-B208-04B4646235C9.jpeg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/33/Unagi.jpg","bundle_template_slots":[{"id":81,"bundle_template_id":33,"category":"highlight","type":"FixedBundleTemplateSlot","meals":[{"id":671,"meal_id":"KABAYAKI","name":"Unagi Kabayaki","temperature":"warm","category":"highlight","byline":"with dill tsukemono on sweet soy japanese rice","price":17,"tag_list":"omega 3, contains sesame, japanese"}]}]},{"id":34,"name":"Caramelised Beef Char Siew","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/34/01B8FF9D-E594-4800-8F2C-68D4F3E3548E.jpeg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/34/Char_Siew.jpg","description":"To produce great char siew is a challenge. To produce great char siew using beef and make it equally tasty, with the perfect caramelisation and meat-to-fat ratio? That, is a challenge at boss level. But well, Chef Isaac nailed it. The smoky and tender meat is balanced with a light sesame barley and brown rice. And on the side lies a charred aubergine with crisp crust and creamy flesh. Gosh, thinking of it makes us hungry already.","byline":"with charred aubergine and sesame barley brown rice","pax_recommendation":null,"base_price":12.95,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/34/01B8FF9D-E594-4800-8F2C-68D4F3E3548E.jpeg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/34/Char_Siew.jpg","bundle_template_slots":[{"id":82,"bundle_template_id":34,"category":"highlight","type":"FixedBundleTemplateSlot","meals":[{"id":670,"meal_id":"BEEFCHARSIEW","name":"Caramelised Beef Char Siew","temperature":"warm","category":"highlight","byline":"with charred aubergine and sesame barley brown rice","price":12.95,"tag_list":"high protein, contains sesame, cantonese"}]}]},{"id":35,"name":"Deconstructed Impossible™ Quarter Pound","image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/35/QUARTERPOUND_hor.jpg","mobile_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/35/QUARTERPOUND.jpg","description":"It tastes like meat. Smells like meat. Looks like meat. No one will ever know it is made from plants, if you keep mum about it. It is incredibly tasty, has all the protein and iron found in beef, and loves the environment. We seared the patty for a crispy outer layer, while keeping it juicy inside. Then, we topped it with just the right amount of secret charred onion glaze. Balance it off with rosemary croutons, balsamic-glazed mushrooms and purple sweet potato for next-level enjoyment.","byline":"with rosemary crouton, balsamic-glazed mushroom and purple sweet potato","pax_recommendation":null,"base_price":18.95,"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/horizontal_image/35/QUARTERPOUND_hor.jpg","vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/alacarte_bundle_template/vertical_image/35/QUARTERPOUND.jpg","bundle_template_slots":[{"id":83,"bundle_template_id":35,"category":"highlight","type":"FixedBundleTemplateSlot","meals":[{"id":650,"meal_id":"QUARTERPOUND","name":"Deconstructed Impossible™ Quarter Pound","temperature":"warm","category":"highlight","byline":"with rosemary crouton, balsamic-glazed mushroom and purple sweet potato","price":18.95,"tag_list":"contains soy, vegetarian, japanese-fusion"}]}]}],"meal_boxes":[{"id":658,"byline":"with roasted root vegetables and balsamic vinaigrette","description":"Red cabbage takes centre stage here, with an extra depth of flavour from the char. This is accompanied by root vegetables, roasted with a dash of salt and pepper for a clean taste and slight smokiness. We brighten the dish with a touch of acidity from our balsamic vinaigrette. If you are eating this with your friends, guard it closely. It can get polished off as soon as it hits the table.","price":10,"temperature":"Warm","category":"regular","ingredients":"cabbage, turnip, pumpkin, sweet potato, purple sweet potato, carrot, quinoa, olive oil, balsamic vinegar, soya sauce, cream, sesame oil, salt, butter, coriander, ginger, vegetable oil, garlic, italian parsley, spring onion, black pepper, chilli powder","nutritions":{"calories":"518","fat":"35g","carb":"51g","protein":"6g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/608/CABBAGEQUINOA_h.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/608/retina_CABBAGEQUINOA_h.jpg","tag_list":"contains dairy, antioxidant-rich, vegetarian","name":"Charred Red Cabbage Quinoa Salad","feedback_rating":null,"feedback_rating_count":41,"price_cents":1000,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/608/CABBAGEQUINOA_v.jpg"},{"id":659,"byline":"with parmesan chimichurri, sautéed kale and portobello","description":"You don’t have to be in a steakhouse to enjoy good steak. You don’t even have to leave your chair — get our Pan-seared Meltique Beef Steak delivered to you. Our meltique beef sirloin is seared for a caramelised brown crust, and served with parmesan chimichurri for a bit of tang. If you ever wondered how heaven tastes like, this is it.","price":21.95,"temperature":"Warm","category":"regular","ingredients":"meltique beef sirloin, corn, kale, button mushroom, portobello, butter, olive oil, basil , italian parsley, parmesan cheese, balsamic vinegar, salt, sugar, black pepper, rosemary","nutritions":{"calories":"644","fat":"38g","carb":"29g","protein":"53g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/609/STEAKANDKALE_h.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/609/retina_STEAKANDKALE_h.jpg","tag_list":"contains dairy, high protein","name":"Pan‑seared Meltique Steak","feedback_rating":null,"feedback_rating_count":90,"price_cents":2195,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/609/STEAKANDKALE_v.jpg"},{"id":657,"byline":"with citrus vinaigrette on parsley-spinach fusilli","description":"This vibrant dish is a real feast for the senses. Norwegian salmon is sous-vided for a smooth and buttery texture. A zesty citrus vinaigrette keeps things fresh along with crunchy edamame beans, cherry tomatoes and fusilli pasta. Super-satisfying and nutritious, it’s as good for you as it looks.","price":16.95,"temperature":"Chilled","category":"regular","ingredients":"salmon, cherry tomato, fusilli, edamame, spinach, salt, italian parsley, lemon juice, calamansi juice, orange juice, garlic, olive oil, sugar, oregano, honey, black pepper, lemon","nutritions":{"calories":"690","fat":"32g","carb":"46g","protein":"48g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/607/SALMONTORCH_h.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/607/retina_SALMONTORCH_h.jpg","tag_list":"high protein","name":"Torched Norwegian Salmon","feedback_rating":null,"feedback_rating_count":"100+","price_cents":1695,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/607/SALMONTORCH_v.jpg"},{"id":656,"byline":"with herbed cherry tomato and pesto on spiced multi-grain rice","description":"Made using succulent chicken thigh, our Grilled Farm Fresh Chicken is garlicky, zesty and pairs perfectly with our multi-grain rice. We seasoned our cherry tomatoes with oregano-infused olive oil to make them sweet and aromatic. Complete with the bold flavours of basil, parsley and peanut in our signature pesto, this dish will have you hooked from the first bite.","price":10,"temperature":"Warm","category":"regular","ingredients":"chicken thigh, broccoli, cherry tomato, brown rice, black rice, peanut, cajun seasoning, tandoori powder, lime powder, vegetable oil, olive oil, basil , black pepper, oregano, salt, sugar, molasses, sesame oil, italian parsley, garlic","nutritions":{"calories":"746","fat":"33g","carb":"70g","protein":"44g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/606/CGFARMFRESH_h.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/606/retina_CGFARMFRESH_h.jpg","tag_list":"contains peanut, high protein","name":"Grilled Farm Fresh Chicken","feedback_rating":null,"feedback_rating_count":"100+","price_cents":1000,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/606/CGFARMFRESH_v.jpg"},{"id":672,"byline":"with ginseng tie guan yin broth","description":"If you are looking for your ordinary thunder tea rice, skip this. But if you want something herbal and flavourful while still retaining the essence of this Hakka dish, this is right up your alley. Just like typical thunder tea rice, this dish has a mix of vegetables and beans. But the key, lies in the ginseng tie guan yin broth. It is packed with nutritious ingredients like ginseng, goji berries and dang gui. An ultimate feel-good dish that makes you happy every time.","price":10,"temperature":"Warm","category":"highlight","ingredients":"round cabbage, egg, tau kwa, long bean, shiitake mushroom, black rice, brown rice, chye poh, shallot, garlic, peanut, celery, barley, chive, spring onion, basil, thai basil, goji berry, salt, vegetable stock, ginseng, sesame oil, vegetable oil, tie guan yin, dang gui","nutritions":{"calories":"694","fat":"32g","carb":"84g","protein":"29g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/622/3D54BC29-F5CF-4EB7-AD07-06DD2AED69C6.jpeg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/622/retina_3D54BC29-F5CF-4EB7-AD07-06DD2AED69C6.jpeg","tag_list":"contains nut, high fibre, vegetarian","name":"Basil Thunder Tea Rice","feedback_rating":null,"feedback_rating_count":"100+","price_cents":1000,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/622/C561B801-A544-488F-9130-6FC540A9C81A.jpeg"},{"id":573,"byline":"with housemade sambal, sunflower seeds and soft-boiled egg","description":"Never mind if Nasi Lemak originated from Singapore or Malaysia. Our healthier version is born in the Grain kitchen and it is absolutely sedap. We seasoned our chicken thigh with a spicy tomato sauce, then baked it to form our own version of the traditional Malaysian dish, Ayam Masak Merah. Aromatic basmati rice is mixed with black and brown rice for extra nutrients and fibre. Topped with housemade sambal and soft-boiled egg, this dish definitely hits the spot.","price":10,"temperature":"Warm","category":"highlight","ingredients":"chicken thigh, egg, japanese cucumber, basmati rice, red onion, sambal chili paste, black rice, coconut cream, ikan bilis (anchovies), brown rice, tomato ketchup, lemongrass, chili, coriander, belacan, sunflower seeds, sugar, vegetable oil, salt, gula melaka, cinnamon stick, cardamom, star anise, garlic, lime leaf, ginger","nutritions":{"calories":"752","fat":"30g","carb":"63g","protein":"57g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/523/Nasi_Lemak.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/523/retina_Nasi_Lemak.jpg","tag_list":"spicy, high protein, local","name":"Nasi Lemak Ayam Masak Merah","feedback_rating":null,"feedback_rating_count":"100+","price_cents":1000,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/523/Nasi_Lemak.jpg"},{"id":671,"byline":"with dill tsukemono on sweet soy japanese rice","description":"This dish is no stranger to Japanese food lovers. That familiar sweet-savoury taste that accompanies a soft, fatty flesh makes it oh-so comforting, especially on a stressful day at work. We serve it with Japanese rice pearls and a refreshing dill tsukemono — Japanese pickles perfumed with fresh herb. The result is a perfect balance of sweet, savoury and tart. Eel like it for sure.","price":17,"temperature":"Warm","category":"highlight","ingredients":"unagi, japanese rice, shiitake mushroom, carrot, japanese cucumber, onion, white vinegar, sugar, teriyaki sauce, dill, salt, sesame oil, sesame seed, black pepper, italian parsley","nutritions":{"calories":"638","fat":"33g","carb":"70g","protein":"24g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/621/008BF66F-1F20-499E-B208-04B4646235C9.jpeg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/621/retina_008BF66F-1F20-499E-B208-04B4646235C9.jpeg","tag_list":"omega 3, contains sesame, japanese","name":"Unagi Kabayaki","feedback_rating":null,"feedback_rating_count":77,"price_cents":1700,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/621/Unagi.jpg"},{"id":670,"byline":"with charred aubergine and sesame barley brown rice","description":"To produce great char siew is a challenge. To produce great char siew using beef and make it equally tasty, with the perfect caramelisation and meat-to-fat ratio? That, is a challenge at boss level. But well, Chef Isaac nailed it. The smoky and tender meat is balanced with a light sesame barley and brown rice. And on the side lies a charred aubergine with crisp crust and creamy flesh. Gosh, thinking of it makes us hungry already.","price":12.95,"temperature":"Warm","category":"highlight","ingredients":"beef shin, aubergine, brown rice, white radish, shiitake mushroom, shimeji mushroom, white vinegar, salted bean paste, sugar, barley, ginger flower, oyster sauce, vegetable oil, sesame seed, sesame oil, curry leaf, salt, black soya sauce, maltose, charcoal","nutritions":{"calories":"711","fat":"24g","carb":"67g","protein":"57g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/620/01B8FF9D-E594-4800-8F2C-68D4F3E3548E.jpeg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/620/retina_01B8FF9D-E594-4800-8F2C-68D4F3E3548E.jpeg","tag_list":"high protein, contains sesame, cantonese","name":"Caramelised Beef Char Siew","feedback_rating":null,"feedback_rating_count":"100+","price_cents":1295,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/620/Char_Siew.jpg"},{"id":650,"byline":"with rosemary crouton, balsamic-glazed mushroom and purple sweet potato","description":"It tastes like meat. Smells like meat. Looks like meat. No one will ever know it is made from plants, if you keep mum about it. It is incredibly tasty, has all the protein and iron found in beef, and loves the environment. We seared the patty for a crispy outer layer, while keeping it juicy inside. Then, we topped it with just the right amount of secret charred onion glaze. Balance it off with rosemary croutons, balsamic-glazed mushrooms and purple sweet potato for next-level enjoyment.","price":18.95,"temperature":"Warm","category":"highlight","ingredients":"impossible mince, onion, purple sweet potato, button mushroom, shiitake mushroom, spinach, roasted sesame dressing, bread, teriyaki sauce, balsamic vinegar, tomato ketchup, vegetable oil, honey, salt, sesame seed, sesame oil, black pepper, olive oil, rosemary","nutritions":{"calories":"681","fat":"36g","carb":"63g","protein":"29g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/600/QUARTERPOUND_hor.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/600/retina_QUARTERPOUND_hor.jpg","tag_list":"contains soy, vegetarian, japanese-fusion","name":"Deconstructed Impossible™ Quarter Pound","feedback_rating":null,"feedback_rating_count":"100+","price_cents":1895,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/600/QUARTERPOUND.jpg"}],"sides":[{"id":665,"byline":"chinese cold tofu with century egg, preserved radish and shallot","description":"There’s tofu, there’s Mapo tofu, there’s ordinary liang ban tofu, and then there’s liang ban tofu with our extraordinary preserved radish mix. It is crunchy, fragrant and an absolute flavour bomb — a perfect match with the refreshing chilled tofu.","price":4.5,"temperature":"Chilled","category":"side","ingredients":"silken tofu, century egg, honey, oyster sauce, spring onion, shallot, soya sauce, sesame oil, red chilli, garlic, sesame seed, salt, sugar","nutritions":{"calories":"216","fat":"13g","carb":"12g","protein":"15g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/615/single_liangbantofu.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/615/retina_single_liangbantofu.jpg","tag_list":"contains egg, contains sesame, chinese","name":"Century Egg Liang Ban Tofu","feedback_rating":null,"feedback_rating_count":40,"price_cents":450,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/615/Toufu_Vertical.JPG"},{"id":667,"byline":"with charred onion mayonnaise","description":"Chances are when you think of Mexico, you think of corn, or food made with corn (like a tortilla). A favourite street food in Mexico, corn is commonly grilled, and served on the cob with a mix of sour cream, parmesan, etc. We took this favourite, removed the kernels from the cob, sautéed them with butter, then topped it up with a little bit of Chef Isaac’s magic - a paprika-spiced charred onion mayonnaise. Tastier and hassle-free, what’s not to love?","price":4.5,"temperature":"Warm","category":"side","ingredients":"corn, garlic, sugar, italian parsley, butter, mayonnaise, onion, paprika powder, salt","nutritions":{"calories":"308","fat":"6g","carb":"37g","protein":"5g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/617/single_mexicancorn.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/617/retina_single_mexicancorn.jpg","tag_list":"contains dairy, high fibre, mexican","name":"Mexican Street Corn","feedback_rating":null,"feedback_rating_count":44,"price_cents":450,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/617/Corn_Vertical.JPG"},{"id":666,"byline":"with spinach and sesame oyster sauce","description":"This is not your typical beancurd skin roll from the dim sum restaurant. This is one that will make you go — holy cow, what kind of beancurd skin rolls have I been eating? We have elevated it with a unique sesame oyster sauce that is incredibly fragrant. One mouthful of this and you will be rolling hard.","price":6.95,"temperature":"Warm","category":"side","ingredients":"spinach, chicken mince, fish, beancurd skin, soybean, carrot, sugar, corn, coriander, red chilli, spring onion, sesame oil, salt, oyster sauce, sesame seed, garlic, potato starch, soya sauce, salt, white pepper, vegetable oil","nutritions":{"calories":"253","fat":"10g","carb":"18g","protein":"24g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/616/single_seafoodroll.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/616/retina_single_seafoodroll.jpg","tag_list":"contains dairy, high protein, cantonese","name":"Seafood Beancurd Skin Roll","feedback_rating":null,"feedback_rating_count":56,"price_cents":695,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/616/Beancurd_Vertical.JPG"}],"desserts":[{"id":661,"byline":"dark chocolate with tasting notes of sun maid raisins and cashew nuts","description":"If Anaimalai 72% Dark is a human being, we would describe him or her as bright and cheery. It is chocolatey, with a pop of nutty flavour and natural sweetness of golden, sun maid raisins. One piece of this chocolate can lift your mood instantly. ","price":5.95,"temperature":"Chilled","category":"dessert","ingredients":"cacao nibs, cocoa butter, unrefined cane sugar","nutritions":{"calories":"180","fat":"11g","carb":"17g","protein":"2g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/611/BENNS_ANAIMALAI.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/611/retina_BENNS_ANAIMALAI.jpg","tag_list":"antioxidant-rich, vegan","name":"Benns Anaimalai 72% Dark Chocolate","feedback_rating":null,"feedback_rating_count":15,"price_cents":595,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/611/benns_anaimalai__1_.jpg"},{"id":660,"byline":"dark chocolate with tasting notes of blackcurrants, raisins and almonds","description":"Sourced from the Koh family farm in Sungai Ruan surrounded by fruit plantations, this chocolate is unlike your usual flat-tasting dark chocolate. It has a unique fruity taste of blackcurrant and raisins. Cacao nibs give it a crunchy texture and a slight roasted flavour with every bite. This is chocolate in its purest form.","price":5.95,"temperature":"Chilled","category":"dessert","ingredients":"cacao nibs, cocoa butter, unrefined cane sugar","nutritions":{"calories":"177","fat":"10g","carb":"19g","protein":"2g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/610/BENNS_SUNGEIRUAN.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/610/retina_BENNS_SUNGEIRUAN.jpg","tag_list":"antioxidant-rich, vegan","name":"Benns Sungai Ruan 72% Dark Chocolate with Cacao Nibs","feedback_rating":null,"feedback_rating_count":12,"price_cents":595,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/610/benns_sungeiruan_1_.jpg"},{"id":663,"byline":"with rosemary, cumin and cayenne pepper","description":"If you are serious about churros, and serious about Belgian waffles, the Cinnamon Churro Waffles was made with you in mind. Golden brown waffles is coated with cinnamon sugar and a combination of Mexican spices like cayenne pepper and cumin, then topped with rosemary. No one would have imagined that the cross-breed of churros and waffles can taste this great. No one, other than the man behind this dessert.","price":4.95,"temperature":"Chilled","category":"dessert","ingredients":"wheat flour, margarine, sugar, egg, yeast, soy flour, salt, soy lecithin, vanilla, cayenne powder, cumin, cinnamon powder, butter, black pepper, rosemary","nutritions":{"calories":"440","fat":"24g","carb":"55g","protein":"6g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/613/single_wafflesmex.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/613/retina_single_wafflesmex.jpg","tag_list":"contains dairy, contains egg, mexican","name":"Cinnamon Churro Waffles","feedback_rating":null,"feedback_rating_count":32,"price_cents":495,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/613/Waffles_Vertical.JPG"},{"id":664,"byline":"rice cake with salted egg yolk filling and grated peanut","description":"It’s hardly a secret that we have a thing for salted egg yolk — we would add them to any food if people don’t judge. So, we were pretty excited when our chefs came up with a rice cake that has salted egg yolk both inside and outside of it. Before you sink your teeth into this dessert, the rich flavour from the salted egg yolk and peanut mixture coats your tongue. And when you take your first bite, the salted egg yolk filling hits you and leaves you in a state of bliss.","price":5.95,"temperature":"Warm","category":"dessert","ingredients":"salted egg glutinous rice ball, peanut, sugar, salted egg yolk, salt","nutritions":{"calories":"438","fat":"21g","carb":"52g","protein":"11g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/614/single_saltedeggmuahchee.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/614/retina_single_saltedeggmuahchee.jpg","tag_list":"contains egg, contains nut, sweet treat","name":"Salted Egg Yolk Muah Chee","feedback_rating":null,"feedback_rating_count":26,"price_cents":595,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/614/Muah_Chee_Vertical.JPG"},{"id":668,"byline":"a medley of grapes, honeydew, kiwi and strawberries sealed in a parcel","description":"Now you have no excuses to skip your daily intake of fruits. We’ve picked the sweetest and juiciest of them all, and cut them into bite-sized pieces for you. Add it to your order for an extra boost after a meal.","price":4.95,"temperature":"Chilled","category":"dessert","ingredients":"grape, honeydew, kiwi, strawberry","nutritions":{"calories":"82","fat":"1g","carb":"20g","protein":"1g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/618/single_fruitplatter.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/618/retina_single_fruitplatter.jpg","tag_list":"high fibre, refreshing","name":"Mixed Fruit Parcel","feedback_rating":null,"feedback_rating_count":22,"price_cents":495,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/618/Fruits_1_Vertical.JPG"}],"drinks":[{"id":186,"byline":"by cocoloco","description":"This coconut water blushes with time due to the natural reaction of a naturally-occurring antioxidant called polyphenol with light. Deeper pinks simply mean higher levels of polyphenols. Only true raw unadulterated coconut water turns pink. No wonder it tastes so good.","price":5.5,"temperature":"Chilled","category":"drink","ingredients":"coconut water","nutritions":{"serving size":"270ml","calories":"59","fat":"0g","carb":"15g","protein":"0g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/136/COCO-new.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/136/retina_COCO-new.jpg","tag_list":"fresh coconut, refreshing","name":"Pink Coconut Water","feedback_rating":null,"feedback_rating_count":"100+","price_cents":550,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/136/COCO-new.jpg"},{"id":511,"byline":"orange, carrot, ginger and turmeric","description":"Little Gingy packs an immunity-boosting kick with the goodness of orange, carrot, ginger and turmeric. Loaded with the anti-inflammatory effects of turmeric and ginger, this is a refreshing and fruity juice that will brighten your day. 100% cold-pressed to keep you at your best. ","price":6.95,"temperature":"Chilled","category":"drink","ingredients":"orange, carrot, ginger, turmeric","nutritions":{"serving size":"300ml","calories":"100","fat":"0g","carb":"22g","protein":"1g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/461/GINGY.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/461/retina_GINGY.jpg","tag_list":"vegan, antioxidant-rich","name":"Little Gingy Cold‑pressed Juice","feedback_rating":null,"feedback_rating_count":"100+","price_cents":695,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/461/GINGY.jpg"},{"id":510,"byline":"watermelon, beetroot, lime, himalayan pink sea salt","description":"The Himalayas will get you back into gear with watermelon, beetroot, lime and Himalayan pink sea salt. The ideal pre-workout elixir, beetroot juice has been proven to aid peak performance among top athletes. Perfectly balanced with refreshing lime and hydrating watermelon, this is the perfect pick-me-up. 100% cold-pressed to keep you at your best.","price":6.95,"temperature":"Chilled","category":"drink","ingredients":"watermelon, beetroot, lime, himalayan pink sea salt ","nutritions":{"serving size":"300ml","calories":"53","fat":"0g","carb":"18g","protein":"1g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/460/HIMALAYAS.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/460/retina_HIMALAYAS.jpg","tag_list":"vegan, antioxidant-rich","name":"The Himalayas Cold‑pressed Juice","feedback_rating":null,"feedback_rating_count":"100+","price_cents":695,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/460/HIMALAYAS.jpg"},{"id":531,"byline":"manuka honey, pineapple, apple and lemon ","description":"A little sweet and a little tangy. This refreshing juice combines the natural sweetness from Manuka honey, pineapple and apple with mild acidity from lemon. Manuka honey, produced in New Zealand is a true superfood with energy-boosting properties. Go ahead and treat yourself to this pure liquid gold.","price":6.95,"temperature":"Chilled","category":"drink","ingredients":"manuka honey, pineapple, apple, lemon ","nutritions":{"serving size":"300ml","calories":"112","fat":"0g","carb":"31g","protein":"0g"},"horizontal_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/481/MANUKA.jpg","retina_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/horizontal_image/481/retina_MANUKA.jpg","tag_list":"antioxidant-rich","name":"Golden Manuka Cold‑pressed Juice","feedback_rating":null,"feedback_rating_count":"100+","price_cents":695,"vertical_image_url":"https://storage.googleapis.com/spineproduction/uploads/recipe/vertical_image/481/MANUKA.jpg"}]}

export class GatewayServer {
  public static readonly PORT: number = 3002;
  // tslint:disable-next-line:variable-name
  private _app: express.Application;
  private server: Server;
  private io: SocketIO.Server;
  private memoryCache: Cache;
  private mqHelper: MQHelper;
  private port: string | number;

  constructor() {
    this._app = express();
    this.port = process.env.PORT || 3002;
    this._app.use(cors());
    this._app.options('*', cors());
    this.server = createServer(this._app);
    this.io = this.initSocket();

    this.listen();
    this.mqHelper = new MQHelper();
    this.memoryCache = cacheManager.caching({
      max: parseInt(process.env.MAX_CACHE || '1000', 1000),
      store: 'memory',
      ttl: parseInt(process.env.TTL || '600', 600) /* 10 minutes */,
    });
    this.listenSocket();
    this.emitSocket();
    this.httpServe();
  }
  get app(): express.Application {
    return this._app;
  }
  private initSocket(): socketIo.Server {
    return socketIo(this.server);
  }

  private listen(): void {
    this._app.use(bodyParser.urlencoded({ extended: false }));
    this._app.use(bodyParser.json());
    this.server.listen(this.port, () => {
      process.stdout.write(`Running server on port ${this.port}\n`);
    });
  }

  private listenSocket(): void {
    this.io.on(CartEvents.CONNECT, (socket: any) => {
      process.stdout.write(`Websocket Connected client on port ${this.port}\n`);

      /* Group Related*/
      socket.on(CartEvents.CREATE_GROUP, (m: ICartGroup) => {
        const groupID = nanoid();
        process.stdout.write(`[server](message): Group Created ${groupID}\n`);

        this.mqHelper.publishMQP(QMethods.CREATE_GROUP, JSON.stringify(m));
      });

      socket.on(CartEvents.DELETE_GROUP, (m: IUser) => {
        this.mqHelper.publishMQP(QMethods.DELETE_GROUP, JSON.stringify(m), (content, msg, err) => {
          process.stdout.write(`[server](message):  ${content}\n`);
        });
      });

      socket.on(CartEvents.USER_JOIN, (m: IUser) => {
        process.stdout.write(`[server](message): User Joined ${m}\n`);

        this.mqHelper.publishMQP(QMethods.USER_JOIN, JSON.stringify(m), (content, msg, err) => {
          process.stdout.write(`[server](message):  ${content}\n`);
        });
      });

      socket.on(CartEvents.USER_LEFT, (m: IUser) => {
        process.stdout.write(`[server](message): User Left \n`);
        // this.io.emit(CartEvents.ACK_USER_LEFT, JSON.stringify({ cartGroupID: groupID, cart_items: [], users: [] }));
        this.mqHelper.publishMQP(QMethods.USER_LEFT, JSON.stringify(m), (content, msg, err) => {
          process.stdout.write(`[server](message):  ${content}\n`);
        });
      });

      /* Item Related */
      socket.on(CartEvents.ADD_ITEM, (m: ICartItem) => {
        this.mqHelper.publishMQP(QMethods.ADD_ITEM, JSON.stringify(m), (content, msg, err) => {
          process.stdout.write(`[server](message):  ${content}\n`);
        });
      });

      socket.on(CartEvents.UPDATE_ITEM, (m: ICartItem) => {
        this.mqHelper.publishMQP(QMethods.UPDATE_ITEM, JSON.stringify(m), (content, msg, err) => {
          process.stdout.write(`[server](message):  ${content}\n`);
        });
      });

      socket.on(CartEvents.REMOVE_ITEM, (m: ICartItem) => {
        this.mqHelper.publishMQP(QMethods.REMOVE_ITEM, JSON.stringify(m), (content, msg, err) => {
          process.stdout.write(`[server](message):  ${content}\n`);
        });
      });

      socket.on(CartEvents.FETCH_CART_GROUP, (m: IUser) => {
        this.mqHelper.publishMQP(QMethods.FETCH_CART_GROUP, JSON.stringify(m), (content, msg, err) => {
          process.stdout.write(`[server](message):  ${content}\n`);
        });
      });

      socket.on(CartEvents.DISCONNECT, () => {
        process.stdout.write('Client disconnected\n');
      });
    });
  }

  private emitSocket(): void {
    this.mqHelper.subscribeMQP(QMethods.ACK_DELETE_GROUP, (msg: any) => {
      const data = (JSON.parse(msg) as IResponse).mutatedItem;
      // process.stdout.write(`\nUSER-JOIN-${CartEvents.ACK_DELETE_GROUP}-${data ? data.cartGroupID : ''}\n`);
      this.io.emit(`${CartEvents.ACK_DELETE_GROUP}-${data ? data.cartGroupID : ''}`, msg);
      // process.stdout.write(`[server](message):  ${msg}\n`);
    });

    this.mqHelper.subscribeMQP(QMethods.ACK_USER_JOIN, (msg: any) => {
      const data = (JSON.parse(msg) as IResponse).data;
      process.stdout.write(`\nUSER-JOIN-${CartEvents.ACK_USER_JOIN}-${data ? data.cartGroupID : ''}\n`);
      this.io.emit(`${CartEvents.ACK_USER_JOIN}-${data ? data.cartGroupID : ''}`, msg);
      // process.stdout.write(`[server](message):${CartEvents.ACK_USER_JOIN}--${msg}\n`);
    });

    this.mqHelper.subscribeMQP(QMethods.ACK_USER_LEFT, (msg: any) => {
      const data = (JSON.parse(msg) as IResponse).data;
      process.stdout.write(`\nUSER-LEFT-${CartEvents.ACK_USER_LEFT}-${data ? data.cartGroupID : ''}\n`);
      this.io.emit(`${CartEvents.ACK_USER_LEFT}-${data ? data.cartGroupID : ''}`, msg);
    });

    this.mqHelper.subscribeMQP(QMethods.ACK_ADD_ITEM, (msg: any) => {
      const data = (JSON.parse(msg) as IResponse).data;
      process.stdout.write(`\nUSER-JOIN-${CartEvents.ACK_ADD_ITEM}-${data ? data.cartGroupID : ''}\n`);
      this.io.emit(`${CartEvents.ACK_ADD_ITEM}-${data ? data.cartGroupID : ''}`, msg);
      // process.stdout.write(`[server](message):  ${msg}\n`);
    });

    this.mqHelper.subscribeMQP(QMethods.ACK_UPDATE_ITEM, (msg: any) => {
      const data = (JSON.parse(msg) as IResponse).data;
      process.stdout.write(`\nUSER-JOIN-${CartEvents.ACK_UPDATE_ITEM}-${data ? data.cartGroupID : ''}\n`);
      this.io.emit(`${CartEvents.ACK_UPDATE_ITEM}-${data ? data.cartGroupID : ''}`, msg);

      // process.stdout.write(`[server](message):  ${msg}\n`);
    });

    this.mqHelper.subscribeMQP(QMethods.ACK_REMOVE_ITEM, (msg: any) => {
      const data = (JSON.parse(msg) as IResponse).data;
      process.stdout.write(`\nUSER-JOIN-${CartEvents.ACK_REMOVE_ITEM}-${data ? data.cartGroupID : ''}\n`);
      this.io.emit(`${CartEvents.ACK_REMOVE_ITEM}-${data ? data.cartGroupID : ''}`, msg);
      // process.stdout.write(`[server](message):  ${msg}\n`);
    });

    this.mqHelper.subscribeMQP(QMethods.ACK_FETCH_CART_GROUP, (msg: any) => {
      const data = (JSON.parse(msg) as IResponse).data;
      process.stdout.write(`\nUSER-JOIN-${CartEvents.ACK_FETCH_CART_GROUP}-${data ? data.cartGroupID : ''}\n`);
      this.io.emit(`${CartEvents.ACK_FETCH_CART_GROUP}-${data ? data.cartGroupID : ''}`, msg);
    });
  }

  private httpServe(): void {
    this._app.get('/menu', async (req: any, res: any) => {
      try {
        const menuUrl: string = 'https://grain.com.sg/menu.json';
        // const cachedResult = await this.memoryCache.get(menuUrl);
        const result ={data:mockData}
          // cachedResult ||
          // (await axios({
          //   method: Method.GET,
          //   url: menuUrl,
          // })).data;

        this.memoryCache.set(menuUrl, result.data, {
          ttl: parseInt(process.env.TTL || '600', 600),
        });

        res.json(result.data);
      } catch (error) {
        const { status = 500, statusText = 'Grain API Error' } = error.response;
        res.status(status).json({
          status,
          statusText,
        });
      }
    });

    this._app.post('/group', async (req: any, res: any) => {
      const payload = req.body;
      await this.mqHelper.publishMQP(QMethods.CREATE_GROUP, JSON.stringify(payload), (callBackmsg, queueName, err) => {
        res.status(200).send({ data: JSON.parse(callBackmsg) });
      });
    });
  }
}
